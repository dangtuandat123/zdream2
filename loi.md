
Priority	Part	Issue	Location	Short	Detail	Steps to Reproduce	Expected	Actual	Fix
High	Integration & Sync	Processing jobs can stall without server-side watchdog	ImageGenerator.php (line 453)<br>CleanupOrphanImages.php (line 27)	Refund/timeout depends on client polling.	Timeout/refund logic only runs in pollImageStatus; if the user leaves or a queue worker is down, processing rows never flip and credits remain locked.	1) Set QUEUE_CONNECTION to async and stop the worker.<br>2) Generate an image and close the tab.<br>3) Wait >5 minutes and check DB.	Processing auto-fails and credits refund without client presence.	Record stays processing; credits remain deducted.	Add a scheduled watchdog to fail/refund old processing rows; consider queue failure monitoring.
High	Image Gen & OpenRouter	Image uploads allowed for models without image-input capability	ImageGenerator.php (line 312)<br>BaseAdapter.php (line 198)	Uploads allowed even if the model cannot accept images.	Input images are always injected into the payload; no validation against supports_image_input or model capabilities.	1) Configure a style with image slots on a model lacking image input (e.g., DALL-E).<br>2) Upload images and generate.	UI blocks uploads or backend rejects before charging.	Request is sent with images; OpenRouter errors and generation fails.	Validate model input capabilities in admin/config and at generation; hide image slots or block with a clear message.
High	Integration & Storage	Cleanup may delete valid files or skip deletions when storage_path is a URL	CleanupOrphanImages.php (line 65)<br>CleanupOrphanImages.php (line 136)	Cleanup assumes storage_path is a relative path.	Cleanup deletes by raw storage_path and checks orphans by exact match; URL-based records can be misclassified.	1) Insert a record with storage_path as a full URL (legacy).<br>2) Run images:cleanup.	Cleanup handles URL-based paths correctly and preserves referenced files.	Files may be deleted as “orphan” or never deleted.	Normalize URL paths (parse to relative) before deleting and when comparing.
High	Logic & UX	Admin can demote self (and potentially remove the last admin)	UserController.php (line 99)	No guard against self-demotion.	Update path allows toggling is_admin for any user, including the current admin.	1) Admin edits own user.<br>2) Uncheck admin and save.	Self-demotion blocked or requires another admin; at least one admin always remains.	Admin loses access; if last admin, system is locked out.	Add a guard to prevent self-demotion or enforce minimum admin count.
Medium	API & Backend	Inactive users can still access API via Sanctum tokens	Kernel.php (line 31)<br>api.php (line 17)	API doesn’t enforce is_active.	EnsureUserIsActive is only in web middleware; API routes skip it.	1) Ban user (is_active=false).<br>2) Call /api/user with existing token.	401/403 for inactive users.	User data is returned.	Apply active middleware to API routes or add explicit checks.
Medium	Image Gen & OpenRouter	Model capability cache not invalidated on refresh	ImageGenerator.php (line 248)<br>SettingsController.php (line 95)	image_capable_model_ids stays stale.	Refresh clears OpenRouter caches but not image_capable_model_ids.	1) Refresh models in admin.<br>2) Generate with a newly supported model.	Validation uses refreshed list immediately.	Validation may still use stale list for up to 1h.	Clear image_capable_model_ids when models/settings are refreshed.
Medium	Logic & UX	Tag cannot be set on style creation	create.blade.php (line 287)<br>StyleController.php (line 151)	Create form lacks tag_id.	Store action accepts tag_id, but create view never sends it.	1) Create a style and look for tag selection.	Tag selectable during creation.	Tag always null until edited later.	Add tag_id field to create form and validate.
Medium	Logic & UX	Aspect ratio options in admin are hard-coded and out of sync with config	create.blade.php (line 273)<br>edit.blade.php (line 255)<br>services_custom.php (line 27)	Admin forms show a subset of supported ratios.	Config defines more ratios than the admin UI exposes.	1) Add a new ratio in config.<br>2) Open create/edit forms.	New ratio appears in admin UI.	New ratio missing.	Render options from $aspectRatios passed by controller.
Medium	Logic & UX	Custom prompt can be stale when generating	image-generator.blade.php (line 193)<br>image-generator.blade.php (line 319)	wire:model.blur can drop last keystrokes.	Textarea updates only on blur; clicking generate can fire before blur syncs.	1) Type custom prompt.<br>2) Click Generate immediately.	Full text is used.	Previous value may be used.	Use wire:model.defer or a form submit to ensure sync.
Medium	Integration & Storage	MinIO disk is public while app assumes private + pre-signed URLs	filesystems.php (line 59)<br>StorageService.php (line 70)	Privacy expectation mismatched with config.	Disk uses public visibility, but UI implies time-limited access.	Generate image and access the direct storage URL externally.	Access only via temporary URL.	Direct URL may work indefinitely.	Set MinIO disk visibility to private and ensure temporary URLs; or update UX copy if public is intended.
Medium	API & Backend	Style updates can fail if OpenRouter API is down or list is incomplete	StyleController.php (line 217)	Validation blocks saving when model list fetch fails.	Validation requires openrouter_model_id to be in fetched models list.	1) Make OpenRouter /models unavailable.<br>2) Edit a style using a non-fallback model.	Admin can save existing model or gets a soft warning.	Validation error blocks save.	Allow existing model IDs or bypass validation when API is unreachable.
Medium	Image Gen & OpenRouter	Total image size validation ignores base64 expansion	ImageGenerator.php (line 613)	Raw size ≠ payload size.	Base64 increases size ~33%, so 25MB raw can exceed provider limits.	Upload images totaling ~25MB and generate.	Validation fails before sending.	Request is sent; provider may reject.	Use stricter raw limit or calculate base64 size.
Low	Image Gen & OpenRouter	Raw OpenRouter error body can surface to users	OpenRouterService.php (line 484)<br>ImageGenerator.php (line 492)	Error messages leak raw response details.	Async failure stores raw response body and displays it in UI.	Trigger OpenRouter error in async mode and wait for failure.	Clean, localized error.	Raw API error snippet shown.	Sanitize user-facing messages; log raw body only.
Low	API & Backend	Response shapes are inconsistent across endpoints	api.php (line 20)<br>InternalApiController.php (line 94)	Mixed envelopes across APIs.	/api/user returns a bare object, internal APIs return {success: ...}.	Call /api/user and /api/internal/wallet/adjust.	Consistent schema or documented differences.	Mixed shapes; client must special-case.	Standardize response envelope or document explicitly.
Low	Integration & Maintainability	Unused artifacts remain	web_debug.php (line 1)<br>RouteServiceProvider.php (line 31)<br>_form.blade.php (line 1)	Dead code increases maintenance overhead.	Debug routes file is not loaded; legacy form partial isn’t referenced.	Search for usage.	No unused files.	Dead artifacts remain.	Remove or wire them explicitly.
API Inventory
Internal APIs

Endpoint	Purpose	Auth	Required Inputs	Optional Inputs	Output	Notes
GET /api/user	Current user info	auth:sanctum	Valid token/session	None	{id,name,email,credits}	No is_active enforcement (see finding).
POST /api/internal/wallet/adjust	Credit/debit user wallet	X-API-Secret header	user_id, amount (non-zero), reason	source, reference_id	{success, transaction_id, new_balance} or {success:false,error}	Throttled throttle:60,1.
POST /api/internal/payment/callback	VietQR webhook credit	X-API-Secret header	user_id, amount, transaction_ref	None	{success, transaction_id, new_balance}	Converts amount/1000 to credits; idempotent by source+reference.
Livewire endpoints (auto)	Image generation, polling, uploads	Session auth	Component state	N/A	Livewire JSON + HTML diff	Livewire handles /livewire/... behind the scenes.
External APIs

External API	Purpose	Endpoint	Headers/Params	Payload/Response	Notes
OpenRouter	Image generation	POST {baseUrl}/chat/completions	Authorization, Content-Type, HTTP-Referer, X-Title	Payload includes model, messages, modalities, optional image_config; response choices[0].message.images[].image_url.url	timeout 120s, retry 3, connectTimeout 15.
OpenRouter	Model discovery	GET {baseUrl}/models	Same headers	Response data[] with modalities	Cached 1h.
OpenRouter	Key/balance	GET {baseUrl}/key	Same headers	Response data	Method exists; no route/UI usage.
VietQR	QR image generation	GET https://api.vietqr.io/image/{bankId}-{accountNumber}-{template}.jpg?...	Query params: accountName, addInfo, optional amount	Image response	Used on wallet page.
Test Gaps

No tests for GenerateImageJob success/failure/refund paths.
No tests for OpenRouter adapter payload/response parsing (Gemini/Flux/GPT/Generic).
No tests for internal API idempotency and validation edge cases.
No tests for cleanup command handling URL vs path storage_path and timeouts.
Assumptions

Third‑party code in vendor/, node_modules/, and public/build/ not audited.
storage_path can be stored as a full URL (controllers already handle this case).
Queue workers can be down or misconfigured in production.
Next steps if you want me to act on this:

Implement fixes for the High‑priority items (watchdog/refund, image‑input validation, cleanup normalization, admin self‑demotion guard).
Align admin UX/config (tags on create, aspect ratios, cache invalidation) and standardize API responses.
Add targeted tests for image generation, OpenRouter parsing, internal APIs, and cleanup.